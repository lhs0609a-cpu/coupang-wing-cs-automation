# 쿠팡 윙 CS 자동화 V3 사용 가이드

## 🎯 V3의 주요 개선사항

### ✨ 핵심 기능
1. **모든 탭에서 미답변이 없을 때까지 자동 반복**
   - 72시간~30일 이내 → 24~72시간 → 24시간 이내 순서로 순회
   - 모든 탭에 미답변이 없을 때까지 계속 반복
   - 최대 100회 반복으로 무한루프 방지

2. **정확한 HTML 구조 매칭**
   - `replying-no-comments` 클래스로 미답변만 정확히 식별
   - 사용자 제공 HTML 구조에 완벽히 매칭:
     ```html
     <td data-v-7fedaa82="" class="replying-no-comments">
       <div class="text-wrapper product-name">
         <a><span title="상품명">상품명</span></a>
       </div>
       <div>
         <span class="inquiry-content">고객 문의 내용</span>
       </div>
     </td>
     ```

3. **자동 답변 생성 및 제출**
   - ChatGPT API로 전문적인 답변 자동 생성
   - 답변하기 버튼 클릭 → 답변 입력 → 저장하기 버튼 클릭
   - 모든 과정 자동화

4. **상세한 로깅 및 에러 처리**
   - 실시간 진행 상황 확인
   - 오류 발생 시 스크린샷 자동 저장
   - 재시도 로직 내장

---

## 📋 사전 준비사항

### 1. 환경 변수 설정
`.env` 파일에 다음 정보를 설정하세요:

```env
# 쿠팡 윙 로그인 정보
COUPANG_WING_USERNAME=your_username
COUPANG_WING_PASSWORD=your_password

# OpenAI API 키 (ChatGPT)
OPENAI_API_KEY=sk-...your_api_key...
OPENAI_MODEL=gpt-4

# 기타
ENVIRONMENT=production
DEBUG=False
```

### 2. 필수 패키지 설치
```bash
pip install selenium openai loguru fastapi
```

### 3. Chrome/ChromeDriver 설치
- Selenium 4.x는 자동으로 ChromeDriver를 관리합니다
- Chrome 브라우저가 설치되어 있어야 합니다

---

## 🚀 사용 방법

### 방법 1: API 엔드포인트 호출

#### 서버가 실행 중이라면:

```bash
# V3 자동화 실행 (권장)
curl -X POST "http://localhost:8000/api/wing-web/auto-answer-v3" \
  -H "Content-Type: application/json" \
  -d '{"headless": false}'
```

#### 브라우저에서 Swagger UI 사용:
1. http://localhost:8000/docs 접속
2. `Wing Web Automation` 섹션 펼치기
3. `POST /api/wing-web/auto-answer-v3` 선택
4. "Try it out" 클릭
5. Request body 설정:
   ```json
   {
     "username": null,
     "password": null,
     "headless": false
   }
   ```
   - `username`, `password`는 null로 두면 .env 파일의 값 사용
   - `headless`:
     - `false` = 브라우저 화면 보임 (디버깅에 유용)
     - `true` = 백그라운드 실행
6. "Execute" 클릭

---

### 방법 2: Python 스크립트로 직접 실행

#### `test_wing_automation_v3.py` 파일 생성:

```python
"""
쿠팡 윙 CS 자동화 V3 테스트 스크립트
"""
import sys
sys.path.append('backend')

from app.services.wing_web_automation_v3 import WingWebAutomationV3
from app.config import settings

def main():
    print("="*70)
    print("쿠팡 윙 CS 자동화 V3 테스트")
    print("="*70)

    # 로그인 정보 확인
    username = settings.COUPANG_WING_USERNAME
    password = settings.COUPANG_WING_PASSWORD

    if not username or not password:
        print("❌ 오류: .env 파일에 COUPANG_WING_USERNAME과 COUPANG_WING_PASSWORD를 설정하세요")
        return

    print(f"✅ 사용자: {username}")
    print(f"✅ OpenAI 모델: {settings.OPENAI_MODEL}")
    print()

    # 자동화 인스턴스 생성
    automation = WingWebAutomationV3(
        username=username,
        password=password,
        headless=False,  # False = 브라우저 보임, True = 백그라운드
        max_rounds=100   # 최대 반복 횟수
    )

    # 실행
    try:
        results = automation.run_full_automation_loop()

        print("\n" + "="*70)
        print("✅ 자동화 완료!")
        print("="*70)
        print(f"성공 여부: {results['success']}")
        print(f"메시지: {results['message']}")
        print(f"통계: {results['statistics']}")
        print("="*70)

    except KeyboardInterrupt:
        print("\n\n⚠️  사용자에 의해 중단되었습니다.")
        automation.cleanup()
    except Exception as e:
        print(f"\n❌ 오류 발생: {str(e)}")
        automation.cleanup()

if __name__ == "__main__":
    main()
```

#### 실행:
```bash
python test_wing_automation_v3.py
```

---

## 📊 실행 과정

### 1단계: 로그인
```
🔐 쿠팡윙 로그인 시작...
  📝 아이디 입력...
  ✅ 아이디 입력 완료
  📝 비밀번호 입력...
  ✅ 비밀번호 입력 완료
  🖱️  로그인 버튼 클릭...
  ✅ 로그인 성공!
```

### 2단계: 페이지 이동
```
📋 고객문의 페이지로 이동...
✅ 고객문의 페이지 이동 완료
```

### 3단계: 라운드별 처리
```
🔄 라운드 1 시작
──────────────────────────────────────────────────────────
📂 [72시간~30일 이내] 탭 처리 중...
──────────────────────────────────────────────────────────
  🔍 '72시간~30일 이내' 탭 찾는 중...
  ✅ '72시간~30일 이내' 탭 클릭 완료
    📥 미답변 문의 수집 중...
    📊 총 5개 미답변 셀 발견
      ✅ 문의 1: 제품 배송 언제 되나요?
      ✅ 문의 2: 사이즈 교환 가능한가요?
    ✅ 총 2개 미답변 문의 수집 완료

  📝 문의 1/2 처리 중...
    상품: [제품명]
    문의: 제품 배송 언제 되나요?
    💬 답변 작성: [제품명]...
      🖱️  답변하기 버튼 클릭...
      🤖 ChatGPT 답변 생성 중...
      ✅ ChatGPT 답변 생성 완료 (150자)
      📝 답변 입력란 찾는 중...
      ✍️  답변 입력 중...
      ✅ 답변 입력 완료 (150자)
      💾 저장하기 버튼 찾는 중...
      🖱️  저장하기 버튼 클릭...
    ✅ 답변 저장 완료!
    ✅ 문의 1 답변 완료!

  ... (문의 2 처리)

✅ [72시간~30일 이내] 탭 처리 완료! (처리: 2개)
```

### 4단계: 완료 조건
```
🎉 모든 탭에 미답변 문의가 없습니다!
✅ 자동화 작업 완료!

📊 최종 처리 통계
──────────────────────────────────────────────────────────
  총 라운드: 3
  총 문의 수: 15
  답변 완료: 14
  답변 실패: 1
  건너뜀: 0
  성공률: 93.3%
──────────────────────────────────────────────────────────
```

---

## 🔧 설정 옵션

### headless 모드
- `false` (권장): 브라우저 화면이 보임
  - 장점: 실시간으로 진행 상황 확인 가능
  - 단점: 화면을 차지함

- `true`: 백그라운드에서 실행
  - 장점: 화면을 차지하지 않음
  - 단점: 디버깅이 어려움

### max_rounds (최대 반복 횟수)
- 기본값: 100
- 무한루프를 방지하기 위한 안전장치
- 일반적으로 2~5 라운드 내에 완료됨

---

## ⚠️ 주의사항

### 1. OpenAI API 키 필수
- ChatGPT로 답변을 생성하려면 OpenAI API 키가 필요합니다
- API 키가 없으면 기본 답변이 사용됩니다

### 2. 네트워크 안정성
- 인터넷 연결이 안정적이어야 합니다
- 쿠팡 윙 사이트가 느리면 시간이 오래 걸릴 수 있습니다

### 3. 브라우저 업데이트
- Chrome 브라우저를 최신 버전으로 유지하세요
- Selenium이 자동으로 ChromeDriver를 관리합니다

### 4. 로그인 정보 보안
- `.env` 파일은 절대 공개 저장소에 업로드하지 마세요
- `.gitignore`에 `.env`가 포함되어 있는지 확인하세요

### 5. API 요금
- OpenAI API 사용량에 따라 요금이 부과됩니다
- GPT-4 사용 시 비용이 높을 수 있으니 주의하세요

---

## 🐛 문제 해결

### 문제 1: "WebDriver 설정 실패"
**원인**: Chrome 브라우저가 설치되지 않았거나 경로를 찾을 수 없음

**해결**:
```bash
# Chrome 브라우저 설치 확인
# Windows: C:\Program Files\Google\Chrome\Application\chrome.exe
# 없다면 Google Chrome 다운로드 및 설치
```

### 문제 2: "로그인 실패"
**원인**: 아이디/비밀번호가 틀렸거나 .env 파일이 제대로 설정되지 않음

**해결**:
1. `.env` 파일에서 아이디/비밀번호 확인
2. 쿠팡 윙 웹사이트에서 직접 로그인 테스트
3. 2단계 인증(OTP) 설정 확인

### 문제 3: "답변 입력란을 찾을 수 없음"
**원인**: 쿠팡 윙 웹사이트 구조가 변경됨

**해결**:
1. 오류 스크린샷 확인 (`error_answer_*.png`)
2. HTML 구조 변경 여부 확인
3. 코드 업데이트 필요 시 개발자에게 문의

### 문제 4: "ChatGPT 답변 생성 오류"
**원인**: OpenAI API 키가 잘못되었거나 요금 한도 초과

**해결**:
1. OpenAI 대시보드에서 API 키 확인
2. 사용량 및 요금 한도 확인
3. API 키를 .env 파일에 정확히 입력했는지 확인

---

## 📈 API 응답 예시

### 성공 응답:
```json
{
  "success": true,
  "message": "총 15개 문의 중 14개 답변 완료",
  "statistics": {
    "total_rounds": 3,
    "total_inquiries": 15,
    "answered": 14,
    "failed": 1,
    "skipped": 0
  }
}
```

### 실패 응답:
```json
{
  "success": false,
  "message": "로그인 실패",
  "statistics": {
    "total_rounds": 0,
    "total_inquiries": 0,
    "answered": 0,
    "failed": 0,
    "skipped": 0
  }
}
```

---

## 🆚 버전 비교

| 기능 | V1 | V2 | V3 (권장) |
|------|----|----|-----------|
| 자동 로그인 | ✅ | ✅ | ✅ |
| 문의 수집 | ✅ | ✅ | ✅ |
| ChatGPT 답변 | ✅ | ✅ | ✅ |
| 시간대별 탭 순회 | ❌ | ✅ | ✅ |
| 미답변만 정확히 식별 | ❌ | ⚠️ | ✅ |
| 모든 탭 완료까지 반복 | ❌ | ❌ | ✅ |
| HTML 구조 정확 매칭 | ⚠️ | ⚠️ | ✅ |
| 에러 핸들링 | ⚠️ | ✅ | ✅ |
| 상세 로깅 | ⚠️ | ✅ | ✅ |

**권장**: V3 사용을 강력히 권장합니다!

---

## 📞 지원

문제가 발생하거나 도움이 필요하시면:
1. 로그 확인: `logs/app.log`
2. 스크린샷 확인: `error_*.png` 파일들
3. 이슈 보고: GitHub Issues에 문의

---

## 📝 라이선스

이 프로젝트는 내부 사용 목적으로 제작되었습니다.

---

**마지막 업데이트**: 2025-01-15
**버전**: V3.0.0
