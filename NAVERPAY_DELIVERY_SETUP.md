# NaverPay 배송 추적 서버 배포 가이드

## 개요

네이버페이 배송 정보를 서버에서 완전 자동으로 수집하는 기능입니다.

### 주요 기능
- **자동 스케줄링**: 간격(분) 또는 Cron 표현식으로 자동 수집
- **쿠키 기반 세션 유지**: 한 번 로그인 후 세션 유지 (캡차 위험 감소)
- **실행 이력 관리**: 모든 스케줄 실행 결과 기록
- **19개 택배사 지원**: 추적 URL 자동 생성

---

## 배포 방법

### 1. Fly.io 메모리 증설 (필수)

Playwright Chromium 실행을 위해 최소 1GB 메모리가 필요합니다.

```bash
# fly.toml에서 이미 설정됨
[[vm]]
  memory_mb = 1024
```

### 2. DB 마이그레이션

```bash
cd backend
python migrate_naverpay_schedule_history.py
```

### 3. Fly.io 배포

```bash
fly deploy
```

### 4. Vercel 프론트엔드 배포

```bash
cd frontend
vercel --prod
```

---

## 사용 방법

### 1. 네이버 로그인

1. **배송 추적** 탭으로 이동
2. **네이버 로그인** 버튼 클릭
3. 아이디/비밀번호 입력 후 로그인
4. 로그인 성공 시 쿠키가 서버에 저장됨 (재로그인 불필요)

> **주의**: 서버에서 로그인 시 캡차가 발생할 수 있습니다. 처음 한 번만 로그인하면 쿠키로 세션이 유지됩니다.

### 2. 스케줄 설정

1. **자동 스케줄** 탭으로 이동
2. **스케줄 추가** 버튼 클릭
3. 스케줄 유형 선택:
   - **간격 반복**: 매 N분마다 실행 (최소 30분)
   - **Cron 표현식**: 특정 시간에 실행

#### Cron 표현식 예시

| 표현식 | 설명 |
|--------|------|
| `0 9 * * *` | 매일 오전 9시 |
| `0 9,18 * * *` | 매일 오전 9시, 오후 6시 |
| `0 */2 * * *` | 매 2시간마다 정각 |
| `30 8 * * 1-5` | 평일 오전 8시 30분 |

### 3. 스케줄 관리

- **재생 버튼**: 즉시 실행
- **일시정지/재개**: 스케줄 활성화 토글
- **삭제**: 스케줄 제거

### 4. 실행 이력 확인

**실행 이력** 탭에서 모든 스케줄 실행 결과를 확인할 수 있습니다:
- 실행 시각
- 발견된 배송 건수
- 신규 저장 건수
- 실행 상태 (성공/실패)

---

## 아키텍처

```
┌─────────────────────────────────────────┐
│           Frontend (Vercel)             │
│  ┌───────────────────────────────────┐  │
│  │   NaverPayDelivery.jsx            │  │
│  │   - 배송 정보 조회                │  │
│  │   - 스케줄 관리 UI                │  │
│  │   - 실행 이력 조회                │  │
│  └───────────────────────────────────┘  │
└────────────────────┬────────────────────┘
                     │ HTTPS
┌────────────────────▼────────────────────┐
│           Backend (Fly.io)              │
│  ┌───────────────────────────────────┐  │
│  │   APScheduler                     │  │
│  │   - 간격/Cron 스케줄 관리         │  │
│  │   - 자동 스크래핑 실행            │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │   Playwright (Chromium)           │  │
│  │   - 네이버 로그인                 │  │
│  │   - 쿠키 기반 세션 유지           │  │
│  │   - 배송 정보 스크래핑            │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │   SQLite Database                 │  │
│  │   - naverpay_deliveries           │  │
│  │   - naverpay_schedules            │  │
│  │   - naverpay_schedule_history     │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

---

## API 엔드포인트

### 인증

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/naverpay/login` | 네이버 로그인 |
| POST | `/api/naverpay/logout` | 로그아웃 |
| GET | `/api/naverpay/login-status` | 로그인 상태 확인 |

### 스크래핑

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/naverpay/scrape` | 수동 스크래핑 |
| GET | `/api/naverpay/deliveries` | 배송 정보 조회 |
| GET | `/api/naverpay/deliveries/stats` | 통계 조회 |

### 스케줄 관리

| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | `/api/naverpay/schedule` | 스케줄 생성 |
| GET | `/api/naverpay/schedule/list` | 스케줄 목록 |
| DELETE | `/api/naverpay/schedule/{job_id}` | 스케줄 삭제 |
| POST | `/api/naverpay/schedule/{job_id}/toggle` | 일시정지/재개 |
| POST | `/api/naverpay/schedule/{job_id}/run-now` | 즉시 실행 |
| GET | `/api/naverpay/schedule/history` | 실행 이력 |

---

## 트러블슈팅

### 로그인 실패

1. **캡차 발생**: 서버 IP에서 처음 로그인 시 캡차가 나올 수 있음
   - 해결: 로컬에서 먼저 로그인하여 쿠키 생성, 또는 잠시 후 재시도

2. **2단계 인증**: 네이버 2단계 인증 설정 시 서버 로그인 불가
   - 해결: 네이버 계정 보안 설정에서 2단계 인증 일시 해제

### 스케줄이 실행되지 않음

1. **로그인 상태 만료**: 쿠키가 만료되면 스케줄이 건너뜀
   - 해결: 다시 로그인하여 쿠키 갱신

2. **스케줄 일시정지 상태**: 스케줄이 비활성화되어 있음
   - 해결: 스케줄 재개 버튼 클릭

### 메모리 부족

```bash
# Fly.io 머신 스케일업
fly scale memory 1024
```

---

## 환경 변수

```env
# 쿠키 저장 경로 (선택, 기본: /data/naver_cookies.json)
COOKIE_STORAGE_PATH=/data/naver_cookies.json
```

---

## 제약 사항

- 네이버 이용약관 준수 필요 (본인 계정만 사용)
- 과도한 요청 시 IP 차단 가능 (최소 30분 간격 권장)
- Playwright Chromium 최소 512MB RAM 필요 (1GB 권장)
